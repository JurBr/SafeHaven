<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Interactive Circular Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100vh; }
    .leaflet-popup-content label {
      display: block; font-weight: bold; margin-top: 0.5em;
    }
    .leaflet-popup-content input,
    .leaflet-popup-content textarea,
    .leaflet-popup-content select {
      width: 100%; margin-top: 0.2em; padding: 5px;
    }
  </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map', {
  center: [51.905, 4.437],
  zoom: 14,
  minZoom: 13,
  maxBounds: [[51.85, 4.30], [51.95, 4.55]]
});

const esriGray = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Tiles &copy; Esri',
  maxZoom: 16
}).addTo(map);

const cartoLight = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap & CartoDB',
  maxZoom: 18
});

const tonerLite = L.tileLayer(
  'https://stamen-tiles.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png', {
  attribution: '&copy; Stamen Design',
  maxZoom: 18
});

const satellite = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Tiles &copy; Esri',
  maxZoom: 18
});

const baseMaps = {
  "Esri Gray": esriGray,
  "Carto Light": cartoLight,
  "Toner Lite": tonerLite,
  "Satellite": satellite
};

L.control.layers(baseMaps).addTo(map);

fetch('map.geojson')
  .then(res => res.json())
  .then(data => {
    const bounds = L.geoJSON(data).getBounds();
    map.fitBounds(bounds);
  });

const stored = JSON.parse(localStorage.getItem("circularPins") || "[]");
stored.forEach(pin => {
  L.marker(pin.latlng).addTo(map).bindPopup(pin.popup);
});

map.on('click', e => {
  const form = `
  <form onsubmit="submitForm(event, this, ${e.latlng.lat}, ${e.latlng.lng})">
    <label>Your Role(s):</label>
    <label><input type="checkbox" name="TypeActor" value="Entrepreneur" /> Entrepreneur</label>
    <label><input type="checkbox" name="TypeActor" value="Civil servant" /> Civil servant</label>
    <label><input type="checkbox" name="TypeActor" value="Researcher" /> Researcher</label>
    <label><input type="checkbox" name="TypeActor" value="Student" /> Student</label>
    <label><input type="checkbox" name="TypeActor" value="Inhabitant" /> Inhabitant</label>
    <label><input type="checkbox" name="TypeActor" value="Port authority" /> Port authority</label>
    <input type="text" name="TypeActorCustom" placeholder="Other (specify)" />

    <label>Your Contribution:</label>
    <textarea name="WatCirculair" required></textarea>

    <label>Pillars of Circularity:</label>
    <label><input type="checkbox" name="PijlerCirculair" value="Refuse, Rethink, Reduce" /> Refuse, Rethink, Reduce</label>
    <label><input type="checkbox" name="PijlerCirculair" value="Substitute" /> Substitute</label>
    <label><input type="checkbox" name="PijlerCirculair" value="Reuse, Repair, Refurbish" /> Reuse, Repair, Refurbish</label>
    <label><input type="checkbox" name="PijlerCirculair" value="Recycle, Recover" /> Recycle, Recover</label>
    <label><input type="checkbox" name="PijlerCirculair" value="Nvt" /> Does not apply</label>

    <label>Scale:</label>
    <select name="Schaal">
      <option value="">Choose...</option>
      <option value="Micro">Micro - local</option>
      <option value="Meso">Meso - regional</option>
      <option value="Macro">Macro - national/global</option>
      <option value="Nvt">Does not apply</option>
    </select>

    <label>What obstacles and barriers do you experience when engaging in circular activities?</label>
    <textarea name="Obstakels"></textarea>

    <label>What makes the Rotterdam Makers District a suitable place for you?</label>
    <textarea name="GeschiktePlek"></textarea>

    <label>The Rotterdam Makers District aims to be a testing ground for the circular future. How does your initiative or organization contribute to this ambition?</label>
    <textarea name="ProeftuinAansluiting"></textarea>

    <button type="submit">Submit</button>
  </form>`;
  L.popup().setLatLng(e.latlng).setContent(form).openOn(map);
});

window.submitForm = (e, form, lat, lng) => {
  e.preventDefault();
  const formData = new FormData(form);
  let summary = "";
  for (let [k, v] of formData.entries()) {
    summary += `<strong>${k}:</strong> ${v}<br>`;
  }

  const popupContent = `<b>Submitted:</b><br>${summary}`;
  L.marker([lat, lng]).addTo(map).bindPopup(popupContent).openPopup();

  const pins = JSON.parse(localStorage.getItem("circularPins") || "[]");
  pins.push({ latlng: { lat, lng }, popup: popupContent });
  localStorage.setItem("circularPins", JSON.stringify(pins));
  map.closePopup();
};

</script>
</body>
</html>
